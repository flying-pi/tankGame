\hypertarget{a00002_source}{}\section{mailboxelement.\+h}
\label{a00002_source}\index{Core/connection/mailboxelement.\+h@{Core/connection/mailboxelement.\+h}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#}\textcolor{preprocessor}{ifndef} \textcolor{preprocessor}{MAILBOXELEMENT\_H}
00002 \textcolor{preprocessor}{#}\textcolor{preprocessor}{define} \textcolor{preprocessor}{MAILBOXELEMENT\_H}
00003 
00004 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \hyperlink{a00008}{"simpleconnection.h"}
00005 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{"../ibasegameelement.h"}
00006 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{QList}\textcolor{preprocessor}{>}
00007 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{QMutex}\textcolor{preprocessor}{>}
00008 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{QQueue}\textcolor{preprocessor}{>}
00009 \textcolor{preprocessor}{#}\textcolor{preprocessor}{include} \textcolor{preprocessor}{<}\textcolor{preprocessor}{qtconcurrentrun}\textcolor{preprocessor}{.}\textcolor{preprocessor}{h}\textcolor{preprocessor}{>}
00010 
00011 \textcolor{keyword}{using} \textcolor{keyword}{namespace} QtConcurrent;
00012 
00013 \textcolor{keyword}{class} \hyperlink{a00197_ace6950e3788bb037f23ce8668ef83829}{MailReceiver};
00014 \textcolor{keyword}{class} \hyperlink{a00205}{MailSender};
00015 
\Hypertarget{a00002_source_l00016}\hyperlink{a00197}{00016} \textcolor{keyword}{class} \hyperlink{a00197_ace6950e3788bb037f23ce8668ef83829}{MailReceiver} \{
00017  \textcolor{keyword}{public}:
\Hypertarget{a00002_source_l00018}\hyperlink{a00197_a0efada2a49e9a841430a8b6f71b6803d}{00018}   \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} \hyperlink{a00197_a0efada2a49e9a841430a8b6f71b6803d}{sendMail}(\hyperlink{a00121_a32f7c4034883ac363ca247c8a2843040}{MessageForServer}* message,
00019                         \hyperlink{a00205}{MailSender}* sender,
00020                         \textcolor{keywordtype}{int} type,
00021                         \textcolor{keywordtype}{bool} isReplace = \textcolor{keyword}{true}) \{
00022     run(QThreadPool::globalInstance(), [=] \{
00023       qInfo() << \textcolor{stringliteral}{"MailReceiver::sendMail - befor mutex"};
00024       isQueueLock = \textcolor{keyword}{true};
00025       mutex.lock();
00026       qInfo() << \textcolor{stringliteral}{"MailReceiver::sendMail - in mutex"};
00027       qInfo() << \textcolor{stringliteral}{"MailReceiver :: adding new message item in to queue"};
00028       mailMessage* msg;
00029       \textcolor{keywordflow}{if} (isReplace && messages.length() != 0) \{
00030         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{int} i = 0; i < messages.length(); i++) \{
00031           msg = messages.at(i);
00032           \textcolor{keywordflow}{if} ((msg->sender == sender && msg->type == type) ||
00033               i == messages.length() - 1) \{
00034             messages.removeAt(i);
00035             messages.insert(i,
00036                             \textcolor{keyword}{new} mailMessage(message, sender, type, isReplace));
00037             \textcolor{keywordflow}{break};
00038           \}
00039         \}
00040       \} \textcolor{keywordflow}{else}
00041         messages.push\_back(\textcolor{keyword}{new} mailMessage(message, sender, type, isReplace));
00042       mailMessage* test = messages.last();
00043       qInfo() << \textcolor{stringliteral}{"getting new message in queue :: "} << (*messages.last());
00044       mutex.unlock();
00045       isQueueLock = \textcolor{keyword}{false};
00046       qInfo() << \textcolor{stringliteral}{"MailReceiver::sendMail - after mutex"};
00047     \});
00048   \}
00049 
00050  \textcolor{keyword}{protected}:
\Hypertarget{a00002_source_l00051}\hyperlink{a00201}{00051}   \textcolor{keyword}{class} \hyperlink{a00201}{mailMessage} \{
00052    \textcolor{keyword}{public}:
\Hypertarget{a00002_source_l00053}\hyperlink{a00201_aa5878557546468fcfb65e099a5d4bf7d}{00053}     \hyperlink{a00121_a32f7c4034883ac363ca247c8a2843040}{MessageForServer}* \hyperlink{a00201_aa5878557546468fcfb65e099a5d4bf7d}{message};
\Hypertarget{a00002_source_l00054}\hyperlink{a00201_a048079ebd149bb973368fd5bedb528a7}{00054}     \hyperlink{a00205}{MailSender}* \hyperlink{a00201_a048079ebd149bb973368fd5bedb528a7}{sender};
\Hypertarget{a00002_source_l00055}\hyperlink{a00201_ad301da15808225e62d84fd5e3cf33a1f}{00055}     \textcolor{keywordtype}{int} \hyperlink{a00201_ad301da15808225e62d84fd5e3cf33a1f}{type};
\Hypertarget{a00002_source_l00056}\hyperlink{a00201_afb7ab5377a6aa4a1e3d836d3e464a952}{00056}     \textcolor{keywordtype}{bool} \hyperlink{a00201_afb7ab5377a6aa4a1e3d836d3e464a952}{isReplace};
\Hypertarget{a00002_source_l00057}\hyperlink{a00201_a0eaa6fb90637fea832337d73b9a83d4d}{00057}     \hyperlink{a00201_a0eaa6fb90637fea832337d73b9a83d4d}{mailMessage}(\hyperlink{a00121_a32f7c4034883ac363ca247c8a2843040}{MessageForServer}* message,
00058                 \hyperlink{a00205}{MailSender}* sender,
00059                 \textcolor{keywordtype}{int} type,
00060                 \textcolor{keywordtype}{bool} isReplace = \textcolor{keyword}{true}) \{
00061       \textcolor{keyword}{this}\hyperlink{a00201_aa5878557546468fcfb65e099a5d4bf7d}{->}\hyperlink{a00201_aa5878557546468fcfb65e099a5d4bf7d}{message} = message;
00062       \textcolor{keyword}{this}\hyperlink{a00201_a048079ebd149bb973368fd5bedb528a7}{->}\hyperlink{a00201_a048079ebd149bb973368fd5bedb528a7}{sender} = sender;
00063       \textcolor{keyword}{this}\hyperlink{a00201_ad301da15808225e62d84fd5e3cf33a1f}{->}\hyperlink{a00201_ad301da15808225e62d84fd5e3cf33a1f}{type} = type;
00064       \textcolor{keyword}{this}\hyperlink{a00201_afb7ab5377a6aa4a1e3d836d3e464a952}{->}\hyperlink{a00201_afb7ab5377a6aa4a1e3d836d3e464a952}{isReplace} = isReplace;
00065     \}
\Hypertarget{a00002_source_l00066}\hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{00066}     \textcolor{keyword}{friend} \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{QDebug} \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{operator}<<(\hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{QDebug} \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{debug}, \textcolor{keyword}{const} 
      \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{mailMessage}& \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{c}) \{
00067       \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{QDebugStateSaver} \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{saver}(\hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{debug});
00068 
00069       \textcolor{keywordflow}{if} (\hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{c}.\hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{message} != \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{nullptr}) \{
00070         \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{debug}.\hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{nospace}() << \textcolor{stringliteral}{"mailMessage \{message:"} << (*\hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{c}.
      \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{message}) << \textcolor{stringliteral}{"\}"};
00071       \} \textcolor{keywordflow}{else} \{
00072         \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{debug}.\hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{nospace}() << \textcolor{stringliteral}{"mailMessage \{message:empty\}"};
00073       \}
00074 
00075       \textcolor{keywordflow}{return} \hyperlink{a00201_a5082ba525e6289ae6fc923e40c68192f}{debug};
00076     \}
00077   \};
\Hypertarget{a00002_source_l00078}\hyperlink{a00197_ace6950e3788bb037f23ce8668ef83829}{00078}   \hyperlink{a00197_ace6950e3788bb037f23ce8668ef83829}{QQueue}<\hyperlink{a00197_ace6950e3788bb037f23ce8668ef83829}{mailMessage}*> \hyperlink{a00197_ace6950e3788bb037f23ce8668ef83829}{messages};
\Hypertarget{a00002_source_l00079}\hyperlink{a00197_a116d4905d302bdb69c00b54b621dd827}{00079}   \hyperlink{a00197_a116d4905d302bdb69c00b54b621dd827}{QMutex} \hyperlink{a00197_a116d4905d302bdb69c00b54b621dd827}{mutex};
\Hypertarget{a00002_source_l00080}\hyperlink{a00197_a33c370cb3c6292cd800008a67002a67f}{00080}   \textcolor{keyword}{volatile} \textcolor{keywordtype}{bool} \hyperlink{a00197_a33c370cb3c6292cd800008a67002a67f}{isQueueLock} = \textcolor{keyword}{false};
00081 
\Hypertarget{a00002_source_l00082}\hyperlink{a00197_a127a70ec582190f90979cb72b8cba72c}{00082}   \textcolor{keyword}{virtual} \hyperlink{a00201}{mailMessage}* \hyperlink{a00197_a127a70ec582190f90979cb72b8cba72c}{nextMessage}() \{
00083     \textcolor{keywordflow}{if} (isQueueLock)
00084       \textcolor{keywordflow}{return} nullptr;
00085     mutex.lock();
00086     \hyperlink{a00201}{mailMessage}* result = nullptr;
00087     \textcolor{keywordflow}{if} (messages.length() > 0) \{
00088       qInfo() << \textcolor{stringliteral}{"enqueue message"};
00089       result = messages.takeFirst();
00090     \}
00091     mutex.unlock();
00092     \textcolor{keywordflow}{return} result;
00093   \}
00094 \};
00095 
\Hypertarget{a00002_source_l00096}\hyperlink{a00205}{00096} \textcolor{keyword}{class} \hyperlink{a00205}{MailSender} \{
00097  \textcolor{keyword}{public}:
00098   \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} \hyperlink{a00205_aba34437231a62861737e97d50f85e7e8}{receiveResponce}(\hyperlink{a00205_aba34437231a62861737e97d50f85e7e8}{QList}<\hyperlink{a00205_aba34437231a62861737e97d50f85e7e8}{DiffElement}*>* 
      \hyperlink{a00205_aba34437231a62861737e97d50f85e7e8}{diff},
00099                                \hyperlink{a00205_aba34437231a62861737e97d50f85e7e8}{MessageForServer}* \hyperlink{a00205_aba34437231a62861737e97d50f85e7e8}{message}) = 0;
\Hypertarget{a00002_source_l00100}\hyperlink{a00205_aa85db0004c26606c5ac294e5de000b96}{00100}   \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} \hyperlink{a00205_aa85db0004c26606c5ac294e5de000b96}{setDefaultReceiver}(\hyperlink{a00197_ace6950e3788bb037f23ce8668ef83829}{MailReceiver}* receiver) \{
00101     \textcolor{keyword}{this}\hyperlink{a00205_aa57ce2f74f8ad76abb38974f85b97ac5}{->}\hyperlink{a00205_aa57ce2f74f8ad76abb38974f85b97ac5}{receiver} = receiver;
00102   \}
00103 
00104  \textcolor{keyword}{protected}:
\Hypertarget{a00002_source_l00105}\hyperlink{a00205_aa57ce2f74f8ad76abb38974f85b97ac5}{00105}   \hyperlink{a00197_ace6950e3788bb037f23ce8668ef83829}{MailReceiver}* \hyperlink{a00205_aa57ce2f74f8ad76abb38974f85b97ac5}{receiver};
00106 \};
00107 
00108 \textcolor{preprocessor}{#}\textcolor{preprocessor}{endif}  \textcolor{comment}{// MAILBOXELEMENT\_H}
\end{DoxyCode}
